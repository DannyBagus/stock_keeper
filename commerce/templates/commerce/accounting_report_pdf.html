{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Umsatzliste</title>
    <style>
        @page {
            size: A4;
            margin: 2cm;
            @frame footer {
                -pdf-frame-content: footer-content;
                bottom: 0cm;
                margin-left: 2cm;
                margin-right: 2cm;
                height: 1cm;
            }
        }
        body {
            font-family: Helvetica, sans-serif;
            font-size: 10pt;
            color: #333;
        }
        .header-table { width: 100%; margin-bottom: 20px; border: none; }
        .logo-cell { width: 50%; font-size: 20pt; font-weight: bold; color: #aa8684; vertical-align: top; }
        .meta-cell { width: 50%; text-align: right; font-size: 9pt; color: #555; vertical-align: top; }
        
        h1 { color: #aa8684; font-size: 16pt; margin-bottom: 5px; }
        h2 { color: #333; font-size: 12pt; margin-top: 20px; border-bottom: 1px solid #aa8684; padding-bottom: 5px; }
        
        .period-info { 
            font-size: 9pt; 
            color: #555; 
            margin-bottom: 20px; 
            border: 1px solid #eee;
            padding: 10px;
            background-color: #f9f9f9;
        }

        /* TABELLEN */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 20px; 
            font-size: 9pt; 
        }
        
        th { 
            border-bottom: 1px solid #aa8684; 
            text-align: left; 
            padding: 4px; 
            font-weight: bold; 
            color: #aa8684; 
        }
        
        td { 
            border-bottom: 1px solid #eee; 
            padding: 4px; 
            vertical-align: top;
        }
        
        .num { text-align: right; }

        .total-row td { 
            font-weight: bold; 
            border-bottom: 3px double #333; 
            padding-top: 6px; 
            padding-bottom: 4px;
        }
        
        .summary-table { width: 100%; border-collapse: collapse; }
        .summary-table th, .summary-table td { padding: 4px; }
    </style>
</head>
<body>

    <!-- HEADER -->
    <table class="header-table">
        <tr>
            <td class="logo-cell">
                SupportElle
                <br><span style="font-size: 10pt; color: #333; font-weight: normal;">Umsatz-Report</span>
            </td>
            <td class="meta-cell">
                Erstellt am: {{ generation_date|date:"d.m.Y H:i" }}<br>
                Mileja GmbH
            </td>
        </tr>
    </table>

    <div class="period-info">
        <strong>Periode:</strong> {{ start_date|date:"d.m.Y" }} bis {{ end_date|date:"d.m.Y" }}
        
        {% if selected_payment_methods %}
            <br>
            <strong>Filter (Zahlung):</strong> {{ selected_payment_methods|join:", " }}
        {% else %}
            <br>
            <strong>Filter (Zahlung):</strong> Alle
        {% endif %}
    </div>

    <!-- 1. ZUSAMMENFASSUNG PRO KATEGORIE -->
    <h2>Zusammenfassung nach Kategorie</h2>
    
    <table class="summary-table">
        <thead>
            <tr>
                <th width="35%">Kategorie</th>
                <th width="20%" align="right">Netto</th>
                <th width="20%" align="right">MwSt</th>
                <th width="25%" align="right">Brutto (Total)</th>
            </tr>
        </thead>
        <tbody>
            {% for cat_name, stats in category_stats.items %}
            <tr>
                <td width="35%">{{ cat_name }}</td>
                <td width="20%" class="num" align="right">{{ stats.net|floatformat:2 }}</td>
                <td width="20%" class="num" align="right">{{ stats.vat|floatformat:2 }}</td>
                <td width="25%" class="num" align="right">{{ stats.gross|floatformat:2 }}</td>
            </tr>
            {% endfor %}

            <tr>
                <td colspan="4" style="border-bottom: 1px solid #333; height: 4px;"></td>
            </tr>

            <tr class="total-row">
                <td width="35%">TOTAL</td>
                <td width="20%" class="num" align="right"></td>
                <td width="20%" class="num" align="right"></td>
                <td width="25%" class="num" align="right">{{ total_period_gross|floatformat:2 }} CHF</td>
            </tr>
        </tbody>
    </table>

    <!-- 2. DETAIL LISTE -->
    <h2>Transaktions-Details</h2>
    
    <table>
        <thead>
            <tr>
                <th style="width: 15%;">Datum/Zeit</th>
                <th style="width: 10%;">ID</th>
                <th style="width: 10%;">Kanal</th>
                <th style="width: 20%;">Erfasser</th>
                <th style="width: 15%;">Zahlart</th>
                <th style="width: 10%;" class="num">Items</th>
                <th style="width: 20%;" class="num">Betrag</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in sales_list %}
            <tr>
                <td>{{ sale.date|date:"d.m.y H:i" }}</td>
                <td>#{{ sale.id }}</td>
                <td>{{ sale.get_channel_display }}</td>
                <td>
                    {% if sale.created_by %}
                        {{ sale.created_by.get_full_name|default:sale.created_by.username }}
                    {% else %}
                        System
                    {% endif %}
                </td>
                <td>{{ sale.get_payment_method_display }}</td>
                <td class="num">{{ sale.items.count }}</td>
                <td class="num">{{ sale.total_amount_gross|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="footer-content">
        <hr style="color: #ddd; height: 1px; border: 0;">
        <p style="text-align: center; font-size: 8pt; color: #aa8684;">Interne Buchhaltungsunterlage - Mileja GmbH</p>
    </div>

</body>
</html>