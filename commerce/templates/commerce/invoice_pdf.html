{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Rechnung #{{ sale.id }}</title>
    <style>
        /* A4 Page Setup */
        @page {
            size: A4;
            /* Ränder für den oberen Teil der Rechnung */
            margin-top: 2cm;
            margin-left: 2cm;
            margin-right: 2cm;
            margin-bottom: 0cm; /* Wichtig für QR Bill unten */
            
            @frame footer {
                -pdf-frame-content: footer-content;
                bottom: 110mm; /* Footer über dem QR Teil */
                margin-left: 2cm;
                margin-right: 2cm;
                height: 1cm;
            }
        }
        
        body {
            font-family: Helvetica, sans-serif; 
            font-size: 10pt;
            color: #333;
            line-height: 1.3;
            margin: 0;
            padding: 0;
        }

        /* --- HEADER & ADDRESS --- */
        table.header-table { width: 100%; border: none; margin-bottom: 20px; }
        td.logo-cell { width: 50%; vertical-align: top; }
        td.address-cell { 
            width: 50%; text-align: right; vertical-align: top; 
            font-size: 9pt; color: #555; 
        }
        .company-name { font-weight: bold; font-size: 10pt; color: #333; margin-bottom: 2px; }

        .recipient-field {
            margin-top: 1cm;
            margin-left: 0cm; 
            font-size: 10pt;
            line-height: 1.4;
            height: 3.5cm; /* Platzhalter für Fensterkuvert */
        }

        /* --- INFO BAR --- */
        table.info-table { width: 100%; font-size: 9pt; border: none; margin-top: 10px; }
        .info-label { font-weight: bold; color: #aa8684; font-size: 8pt; text-transform: uppercase; }

        /* --- ITEMS TABLE --- */
        table.items-table { 
            width: 100%; border-collapse: collapse; margin-top: 10mm; font-size: 9pt; 
        }
        .items-table th { 
            color: #aa8684; border-bottom: 1px solid #aa8684; padding: 5px 2px; 
            text-align: left; font-weight: bold; text-transform: uppercase; font-size: 8pt; 
        }
        .items-table td { border-bottom: 1px solid #eee; padding: 6px 2px; vertical-align: top; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }

        /* --- SUMMARY --- */
        .summary-row td { border-bottom: 1px solid #eee; padding: 4px 2px; }
        .summary-total-cell { 
            border-top: 1px solid #aa8684; border-bottom: 3px double #aa8684; 
            font-weight: bold; font-size: 11pt; color: #333; padding: 5px 0; 
        }

        /* --- SWISS QR BILL STYLES (DIN 5008 / SIX) --- */
        .qr-bill-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 210mm;
            height: 105mm; /* Exakt A6 quer */
            border-top: 1px dashed #333; /* Trennlinie */
            font-family: Arial, Helvetica, sans-serif; /* Vorgeschrieben */
            color: #000;
            background-color: #fff;
            page-break-inside: avoid;
        }

        /* Empfangsschein (Links) */
        .receipt-section {
            position: absolute;
            top: 5mm;
            left: 5mm;
            width: 52mm;
            font-size: 8pt;
            line-height: 11pt;
        }
        
        /* Zahlteil (Rechts) */
        .payment-section {
            position: absolute;
            top: 5mm;
            left: 67mm; /* 62mm + 5mm padding */
            width: 138mm;
            font-size: 10pt;
            line-height: 13pt;
        }

        .qr-title { font-weight: bold; font-size: 11pt; margin-bottom: 5mm; }
        .qr-title-small { font-weight: bold; font-size: 9pt; margin-bottom: 5mm; }
        
        .qr-label { font-weight: bold; font-size: 6pt; line-height: 8pt; margin-top: 3pt;} /* Empfangsschein Labels */
        .qr-label-pay { font-weight: bold; font-size: 8pt; line-height: 9pt; margin-top: 10pt; } /* Zahlteil Labels */

        .qr-data { margin-bottom: 2mm; }

        /* Der eigentliche QR Code Container (46x46mm) */
        .qr-code-box {
            position: absolute;
            top: 5mm; /* Relativ zur payment-section */
            left: 0;
            width: 46mm;
            height: 46mm;
        }
        
        /* FIX: Erzwinge SVG Größe NUR für den QR Code (nicht für das Kreuz) */
        .qr-code-box svg:not(.swiss-cross) {
            width: 46mm !important;
            height: 46mm !important;
            display: block;
        }
        
        /* Swiss Cross Overlay */
        .swiss-cross {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 7mm !important;
            height: 7mm !important;
            background: black; /* Umrandung des Kreuzes ist eigentlich weiss, aber hier simpler */
            z-index: 10;
        }
        
        .amount-box {
            margin-top: 10mm;
        }
        .currency-field { float: left; width: 15mm; margin-right: 2mm; }
        .amount-field { float: left; }
    </style>
</head>
<body>

    <!-- FOOTER CONTENT (Oberhalb der Perforation) -->
    <div id="footer-content">
        <p style="text-align: center; font-size: 8pt; color: #aa8684; margin: 0;">
            Danke für Ihren Einkauf bei Mileja GmbH.<br>
            Es gelten unsere AGB.
        </p>
    </div>

    <!-- HEADER BLOCK -->
    <table class="header-table">
        <tr>
            <td class="logo-cell">
                <!-- Logo -->
                <img src="{% static 'img/SupportElle_Logo-4.webp' %}" alt="SupportElle" style="height: 150px; width: auto;">
            </td>
            <td class="address-cell">
                <div class="company-name">Mileja GmbH</div>
                Rittergasse 20<br>
                CH-4051 Basel<br>
                UID: CHE-170.569.062<br>
                Web: shop.mileja.ch
            </td>
        </tr>
    </table>

    <!-- KUNDENADRESSE (Linksbündig für C5 Kuvert) -->
    <div class="recipient-field">
        {{ customer.first_name }} {{ customer.last_name }}<br>
        {{ customer.address }}<br>
        {{ customer.zip_code }} {{ customer.city }}
    </div>

    <!-- TRENNLINIE -->
    <hr style="color: #aa8684; background-color: #aa8684; height: 1px; border: 0; margin-bottom: 10px;">

    <!-- BELEG INFOS -->
    <table class="info-table">
        <tr>
            <td width="33%">
                <span class="info-label">Rechnungsdatum</span><br>
                {{ formatted_date }}
            </td>
            <td width="33%">
                <span class="info-label">Fälligkeit</span><br>
                Zahlbar innert 30 Tagen
            </td>
            <td width="34%" class="text-right">
                <span class="info-label">Rechnungs-Nr.</span><br>
                #{{ sale.id }}
            </td>
        </tr>
    </table>

    <!-- ARTIKEL TABELLE -->
    <table class="items-table">
        <thead>
            <tr>
                <th width="5%">Pos.</th> 
                <th width="50%">Artikel</th>
                <th width="10%" class="text-center">Menge</th>
                <th width="15%" class="text-right">Preis</th> 
                <th width="20%" class="text-right">Total</th> 
            </tr>
        </thead>
        <tbody>
            {% for item in items %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>
                    {{ item.product.name }}<br>
                    <span style="font-size: 7pt; color: #888;">{{ item.product.sku|default:item.product.ean }}</span>
                </td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-right">{{ item.unit_price_gross|floatformat:2 }}</td>
                <td class="text-right">{{ item.total_price_gross|floatformat:2 }}</td>
            </tr>
            {% endfor %}
            
            <tr><td colspan="5" style="border: none; height: 10px;"></td></tr>

            <!-- ZUSAMMENFASSUNG -->
            <tr class="summary-row">
                <td colspan="4" class="text-right">Netto (exkl. MwSt):</td>
                <td class="text-right">{{ total_cost_net|floatformat:2 }}</td>
            </tr>
            <tr class="summary-row">
                <td colspan="4" class="text-right" style="color: #888; font-size: 8pt;">MwSt ({{ mwst_rate_percent }}%):</td>
                <td class="text-right" style="color: #888; font-size: 8pt;">{{ total_mwst|floatformat:2 }}</td>
            </tr>
            <tr>
                <td colspan="4" class="text-right summary-total-cell" style="border-left: none; border-right: none;">TOTAL CHF</td>
                <td class="text-right summary-total-cell" style="border-left: none; border-right: none;">{{ total_cost_gross|floatformat:2 }}</td>
            </tr>
        </tbody>
    </table>

    <!-- SWISS QR BILL SECTION (Bottom of Page) -->
    <div class="qr-bill-container">
        
        <!-- --- EMPFANGSSCHEIN (Links) --- -->
        <div class="receipt-section">
            <div class="qr-title-small">Empfangsschein</div>
            
            <div class="qr-label">Konto / Zahlbar an</div>
            <div class="qr-data">
                CH41 0900 0000 1526 5286 7<br>
                Mileja GmbH<br>
                Rittergasse 20<br>
                4051 Basel
            </div>

            <div class="qr-label">Referenz</div>
            <div class="qr-data"><!-- Leer bei NON --></div>

            <div class="qr-label">Zahlbar durch</div>
            <div class="qr-data">
                {{ customer.first_name }} {{ customer.last_name }}<br>
                {{ customer.address }}<br>
                {{ customer.zip_code }} {{ customer.city }}
            </div>

            <div class="amount-box">
                <div class="currency-field">
                    <div class="qr-label">Währung</div>
                    <div class="qr-data">CHF</div>
                </div>
                <div class="amount-field">
                    <div class="qr-label">Betrag</div>
                    <div class="qr-data">{{ total_cost_gross|floatformat:2 }}</div>
                </div>
            </div>
        </div>

        <!-- --- ZAHLTEIL (Rechts) --- -->
        <div class="payment-section">
            <div class="qr-title">Zahlteil</div>
            
            <!-- QR Code Grafik mit Schweizer Kreuz -->
            <div class="qr-code-box">
                 <!-- SVG vom Backend generiert -->
                 {{ qr_code_svg|safe }}
                 
                 <!-- Das Schweizer Kreuz -->
                 <svg class="swiss-cross" viewBox="0 0 7 7" xmlns="http://www.w3.org/2000/svg">
                    <rect x="0" y="0" width="7" height="7" fill="black"/>
                    <rect x="0.8" y="0.8" width="5.4" height="5.4" fill="white"/> <!-- Weisser Rand -->
                    <rect x="2.6" y="1.8" width="1.8" height="3.4" fill="black"/> <!-- Vertikaler Balken -->
                    <rect x="1.8" y="2.6" width="3.4" height="1.8" fill="black"/> <!-- Horizontaler Balken -->
                 </svg>
            </div>

            <!-- Text Infos Rechts neben dem QR Code -->
            <!-- Margin-Left von 50mm relativ zum Payment-Section Start -->
            <div style="margin-left: 50mm;">
                <div class="qr-label-pay">Währung</div>
                <div style="float: left; width: 15mm; margin-bottom: 2mm;">CHF</div>
                
                <div class="qr-label-pay">Betrag</div>
                <div style="margin-bottom: 2mm;">{{ total_cost_gross|floatformat:2 }}</div>

                <div class="qr-label-pay">Konto / Zahlbar an</div>
                <div class="qr-data">
                    CH41 0900 0000 1526 5286 7<br>
                    Mileja GmbH<br>
                    Rittergasse 20<br>
                    4051 Basel
                </div>

                <div class="qr-label-pay">Referenz</div>
                <div class="qr-data"><!-- Leer --></div>

                <div class="qr-label-pay">Zusätzliche Informationen</div>
                <div class="qr-data">Rechnung #{{ sale.id }}</div>

                <div class="qr-label-pay">Zahlbar durch</div>
                <div class="qr-data">
                    {{ customer.first_name }} {{ customer.last_name }}<br>
                    {{ customer.address }}<br>
                    {{ customer.zip_code }} {{ customer.city }}
                </div>
            </div>
        </div>
    </div>

</body>
</html>