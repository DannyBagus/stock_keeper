{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

<script>
    function scannerApp() {
        return {
            searchQuery: '', searchResults: [], noResults: false,
            scanner: null, isCameraActive: false, showScannerControls: false, scanCooldown: false,

            init() { this.$nextTick(() => this.focusSearch()); },

            focusSearch() {
                const el = document.getElementById('search-input');
                if(el) el.focus();
            },

            toggleCamera() { if (this.isCameraActive) this.stopCamera(); else this.startCameraScanner(); },
            
            startCameraScanner() {
                this.isCameraActive = true;
                this.$nextTick(() => {
                    const formats = [Html5QrcodeSupportedFormats.EAN_13, Html5QrcodeSupportedFormats.EAN_8, Html5QrcodeSupportedFormats.QR_CODE, Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.UPC_A];
                    if (!this.scanner) this.scanner = new Html5Qrcode("reader");
                    this.scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: { width: 280, height: 180 }, aspectRatio: 1.0, formatsToSupport: formats, experimentalFeatures: { useBarCodeDetectorIfSupported: true } },
                        (decodedText) => {
                            if (this.scanCooldown) return;
                            if (this.searchQuery !== decodedText) {
                                this.scanCooldown = true; this.searchQuery = decodedText;
                                if (navigator.vibrate) navigator.vibrate(200);
                                this.performSearch(true);
                                setTimeout(() => { this.scanCooldown = false; }, 1500);
                            }
                        }, (err) => {}
                    ).then(() => { this.showScannerControls = true; this.setupZoom(); }).catch(err => { this.isCameraActive = false; });
                });
            },
            stopCamera() {
                if (this.scanner) this.scanner.stop().then(() => { this.isCameraActive = false; this.focusSearch(); }).catch(e=>{});
                else this.isCameraActive = false;
            },
            setupZoom() {
                const slider = document.getElementById('zoom-slider');
                if(slider) slider.addEventListener('input', (e) => { try { this.scanner.applyVideoConstraints({ advanced: [{ zoom: parseFloat(e.target.value) }] }); } catch(e){} });
            },

            async performSearch(isEnterPress) {
                if (this.searchQuery.length < 2) { this.searchResults = []; return; }
                if (isEnterPress) this.scanCooldown = true;
                const res = await fetch(`/commerce/api/search/?q=${this.searchQuery}`);
                const data = await res.json();
                this.searchResults = data.results;
                this.noResults = this.searchResults.length === 0;
                if (isEnterPress && this.searchResults.length === 1) this.openProduct(this.searchResults[0]);
                if (isEnterPress && this.noResults) { setTimeout(() => { this.scanCooldown = false; }, 1000); this.searchQuery = ''; this.focusSearch(); }
            },
            openProduct(product) { window.location.href = `/admin/core/product/${product.id}/change/`; }
        }
    }
</script>

<style>
    /* Identische Styles */
    #reader { width: 100%; border-radius: 8px; overflow: hidden; background: #000; min-height: 250px; }
    #reader video { object-fit: cover; border-radius: 8px; }
    .scanner-controls { background: #f8f9fa; padding: 10px; border-radius: 0 0 8px 8px; border: 1px solid #ddd; border-top: none; margin-bottom: 15px; }
    .zoom-slider { width: 100%; }
    .search-box { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 4px solid #17a2b8; } /* Info-Blau für Scanner */
    .product-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; border: 1px solid #eee; display: none; }
    .product-list.active { display: block; }
    .product-list li { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.1s; }
    .product-list li:hover { background-color: #f0f4f8; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 800px;" x-data="scannerApp()" x-init="init()">
    
    <div class="row mb-3 align-items-center">
        <div class="col-8">
            <h2><i class="fas fa-search text-info"></i> Produkt finden & bearbeiten</h2>
        </div>
        <div class="col-4 text-right">
            <button class="btn btn-outline-secondary btn-sm" @click="toggleCamera()">
                <i class="fas" :class="isCameraActive ? 'fa-times' : 'fa-camera'"></i> 
                <span x-text="isCameraActive ? 'Kamera aus' : 'Kamera an'"></span>
            </button>
        </div>
    </div>

    <!-- KAMERA -->
    <div class="card mb-3 border-0 shadow-sm" x-show="isCameraActive" style="display: none;">
        <div class="card-body p-0">
            <div id="reader"></div>
            <div class="scanner-controls" x-show="showScannerControls">
                <div class="d-flex align-items-center">
                    <i class="fas fa-search-minus mr-2 text-muted"></i>
                    <input type="range" id="zoom-slider" class="zoom-slider custom-range" min="1" max="5" step="0.1" value="1">
                    <i class="fas fa-search-plus ml-2 text-muted"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- SUCHE -->
    <div class="search-box">
        <label class="h5 mb-3 d-block text-muted">Produkt scannen oder suchen</label>
        <div class="input-group input-group-lg mb-3">
            <input type="text" id="search-input" class="form-control" 
                   placeholder="EAN oder Name..." 
                   x-model="searchQuery" 
                   @keydown.enter.prevent="performSearch(true)" 
                   @input.debounce.300ms="performSearch(false)"
                   autofocus>
            <div class="input-group-append">
                <button class="btn btn-primary" @click="performSearch(true)">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
        
        <ul class="product-list" :class="{ 'active': searchResults.length > 0 }">
            <template x-for="product in searchResults" :key="product.id">
                <li @click="openProduct(product)">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong x-text="product.name" class="h5 d-block mb-1"></strong>
                            <span class="badge badge-light border mr-1" x-text="product.ean || 'Keine EAN'"></span>
                            <span class="text-muted small">Lager: <span x-text="product.stock"></span></span>
                        </div>
                        <div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                    </div>
                </li>
            </template>
        </ul>
        
        <div x-show="noResults" class="alert alert-warning mt-3">
            <i class="fas fa-exclamation-triangle mr-2"></i> Kein Produkt gefunden.
            <br>
            <small>Möchten Sie ein <a href="/admin/core/product/add/" class="font-weight-bold">neues Produkt anlegen</a>?</small>
        </div>
    </div>

</div>
{% endblock %}