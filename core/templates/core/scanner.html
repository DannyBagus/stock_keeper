{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<style>
    /* Optimierungen für Mobile View */
    #reader {
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        background: #000;
        margin-bottom: 15px;
    }
    #reader video {
        object-fit: cover;
        border-radius: 8px;
    }
    .scanner-controls {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #ddd;
    }
    .zoom-container {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
    }
    .zoom-slider {
        flex-grow: 1;
        height: 25px;
    }
</style>
{% endblock %}

{% block content %}
<div class="col-12 col-lg-8 offset-lg-2">
    <div class="card card-primary card-outline">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title"><i class="fas fa-barcode mr-2"></i> Produkt Scanner</h3>
        </div>
        <div class="card-body">
            
            <!-- Handscanner Input (Immer sichtbar & fokussiert) -->
            <form method="POST" id="scan-form" class="mb-4">
                {% csrf_token %}
                <div class="form-group">
                    <label>Handscanner / Manuelle Eingabe</label>
                    <div class="input-group input-group-lg">
                        <input type="text" name="ean" id="ean-input" class="form-control" placeholder="EAN scannen oder tippen..." autofocus>
                        <div class="input-group-append">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <small class="form-text text-muted">Cursor hier platzieren und scannen.</small>
                </div>
            </form>

            <hr>

            <!-- Kamera Toggle Button -->
            <div class="text-center mb-3">
                <button id="toggle-camera-btn" class="btn btn-outline-secondary">
                    <i class="fas fa-camera"></i> Kamera-Scanner öffnen
                </button>
            </div>

            <!-- Kamera Bereich (Standardmäßig versteckt) -->
            <div id="camera-section" style="display: none;">
                <div id="reader" style="min-height: 300px;"></div>

                <!-- Controls Area (Zoom & Torch) -->
                <div class="scanner-controls" id="controls" style="display:none;">
                    <div class="row">
                        <div class="col-12 mb-2">
                            <strong><i class="fas fa-search-plus"></i> Zoom</strong>
                            <div class="zoom-container">
                                <i class="fas fa-minus small"></i>
                                <input type="range" id="zoom-slider" class="zoom-slider" min="1" max="5" step="0.1" value="1">
                                <i class="fas fa-plus small"></i>
                            </div>
                        </div>
                        <div class="col-6">
                            <button id="torch-btn" class="btn btn-outline-warning btn-block btn-sm" disabled>
                                <i class="fas fa-lightbulb"></i> Licht
                            </button>
                        </div>
                        <div class="col-6">
                            <button id="restart-btn" class="btn btn-outline-secondary btn-block btn-sm">
                                <i class="fas fa-sync"></i> Neustart
                            </button>
                        </div>
                    </div>
                </div>
                <div id="scan-result" class="mt-3 font-weight-bold text-center text-success h5"></div>
            </div>

        </div>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
    // Globale Variable für den Scanner
    let html5QrCode = null;

    // Toggle Logik
    document.getElementById('toggle-camera-btn').addEventListener('click', function() {
        const section = document.getElementById('camera-section');
        if (section.style.display === 'none') {
            section.style.display = 'block';
            this.innerHTML = '<i class="fas fa-times"></i> Kamera schließen';
            this.classList.remove('btn-outline-secondary');
            this.classList.add('btn-secondary');
            startCamera(); // Erst jetzt starten wir die Kamera
        } else {
            section.style.display = 'none';
            this.innerHTML = '<i class="fas fa-camera"></i> Kamera-Scanner öffnen';
            this.classList.add('btn-outline-secondary');
            this.classList.remove('btn-secondary');
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    console.log("Kamera gestoppt");
                }).catch(err => console.log(err));
            }
            // Fokus zurück auf Input
            document.getElementById('ean-input').focus();
        }
    });

    const onScanSuccess = (decodedText, decodedResult) => {
        if (document.getElementById('ean-input').value === decodedText) return;

        if (navigator.vibrate) navigator.vibrate(200);

        document.getElementById('ean-input').value = decodedText;
        document.getElementById('scan-result').innerText = "Gelesen: " + decodedText;

        setTimeout(() => {
             document.getElementById('scan-form').submit();
        }, 600);
    };

    const startCamera = () => {
        const formatsToSupport = [
            Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8,
            Html5QrcodeSupportedFormats.QR_CODE,
            Html5QrcodeSupportedFormats.CODE_128,
            Html5QrcodeSupportedFormats.UPC_A,
        ];

        const config = {
            fps: 15, 
            qrbox: { width: 280, height: 180 }, 
            aspectRatio: 1.0,
            formatsToSupport: formatsToSupport,
            experimentalFeatures: { useBarCodeDetectorIfSupported: true }
        };

        html5QrCode = new Html5Qrcode("reader");

        html5QrCode.start(
            { facingMode: "environment" }, 
            config,
            onScanSuccess,
            (errorMessage) => { }
        ).then(() => {
            document.getElementById('controls').style.display = 'block';
            setupCameraControls();
        }).catch((err) => {
            console.error(err);
            alert("Kamera konnte nicht gestartet werden (HTTPS?).");
        });
    };

    const setupCameraControls = () => {
        try {
            const zoomSlider = document.getElementById('zoom-slider');
            zoomSlider.addEventListener('input', (event) => {
                applyZoom(event.target.value);
            });

            const torchBtn = document.getElementById('torch-btn');
            torchBtn.disabled = false; 
            torchBtn.addEventListener('click', () => {
                toggleTorch();
            });

        } catch (e) {
            console.log("Erweiterte Kamera-Kontrollen nicht verfügbar", e);
        }
    };

    const applyZoom = (zoomValue) => {
        try {
            html5QrCode.applyVideoConstraints({
                advanced: [{ zoom: parseFloat(zoomValue) }]
            });
        } catch (err) {}
    };

    let isTorchOn = false;
    const toggleTorch = () => {
        try {
            isTorchOn = !isTorchOn;
            html5QrCode.applyVideoConstraints({
                advanced: [{ torch: isTorchOn }]
            });
            // Button Style Logik...
        } catch (err) {}
    };

    document.getElementById('restart-btn').addEventListener('click', () => {
        html5QrCode.stop().then(() => {
            startCamera();
        });
    });

    // WICHTIG: Fokus beim Laden setzen (für Handscanner)
    window.onload = function() {
        document.getElementById('ean-input').focus();
    };

</script>
{% endblock %}